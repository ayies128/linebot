# LINE Bot & Google Calendar 統合システム 要件仕様書

## 1. プロジェクト概要

### 1.1 目的

LINE会話履歴とGoogleカレンダーを統合し、日常のタスク管理と意思決定をサポートするシステムを構築する。

### 1.2 背景

- LINE上での会話の進捗状況を把握したい
- Googleカレンダーの予定と連携して、効率的なスケジュール管理を実現したい
- タスク管理と意思決定を自動化・効率化したい

### 1.3 スコープ

- LINE Messaging APIを使用したメッセージ受信・送信機能
- Google Calendar APIを使用したイベント管理機能
- 会話履歴とカレンダーイベントの統合処理
- プライバシーとセキュリティを考慮したデータ処理

---

## 2. 機能要件

### 2.1 LINE連携機能

#### 2.1.1 メッセージ受信

- **Webhook対応**: LINE Messaging APIのWebhookを使用してメッセージをリアルタイムで受信
- **メッセージタイプ**: テキスト、画像、スタンプ、位置情報などの各種メッセージタイプに対応
- **グループ/個人チャット対応**: 個人チャットとグループチャットの両方に対応

#### 2.1.2 メッセージ送信

- **自動応答**: 特定のキーワードやパターンに基づく自動応答
- **プッシュ通知**: カレンダーイベントに基づくリマインダー送信
- **リッチメッセージ**: Flex MessageやTemplate Messageを使用した視覚的なメッセージ送信

#### 2.1.3 会話履歴管理

- **履歴保存**: 会話履歴をデータベースに保存
- **進捗トラッキング**: 会話の進捗状況を追跡・分析
- **検索機能**: 過去の会話を検索可能にする

### 2.2 Google Calendar連携機能

#### 2.2.1 イベント取得

- **日次スケジュール取得**: 当日および指定期間のイベントを取得
- **イベント詳細**: タイトル、時間、場所、参加者などの詳細情報を取得
- **定期イベント対応**: 繰り返しイベントの処理

#### 2.2.2 イベント作成・更新

- **LINEからのイベント作成**: LINE上のメッセージからカレンダーイベントを作成
- **イベント更新**: 既存イベントの時間や詳細を更新
- **イベント削除**: 不要なイベントの削除

#### 2.2.3 リマインダー機能

- **事前通知**: イベント開始前にLINEで通知
- **カスタマイズ可能な通知時間**: ユーザーごとに通知タイミングを設定可能

### 2.3 統合機能

#### 2.3.1 タスク管理

- **会話からタスク抽出**: LINE会話から自動的にタスクを抽出
- **カレンダーとの同期**: 抽出したタスクをカレンダーイベントとして登録
- **進捗管理**: タスクの完了状況を追跡

#### 2.3.2 意思決定支援

- **スケジュール最適化**: 空き時間の提案
- **会議調整**: 複数人の予定を考慮した会議時間の提案
- **優先度判定**: タスクやイベントの優先度を自動判定

#### 2.3.3 レポート機能

- **日次サマリー**: 1日の予定と会話の要約をLINEで送信
- **週次レポート**: 週間の活動状況をレポート
- **統計情報**: 会話量、タスク完了率などの統計

---

## 3. 非機能要件

### 3.1 セキュリティ・プライバシー

#### 3.1.1 データ保護

- **暗号化**: 保存データおよび通信データの暗号化
- **アクセス制御**: 認証・認可機能の実装
- **個人情報保護**: GDPR、個人情報保護法への準拠

#### 3.1.2 API認証

- **LINE**: Channel Access Tokenの安全な管理
- **Google**: OAuth 2.0による認証
- **環境変数管理**: 機密情報は環境変数で管理

### 3.2 パフォーマンス

#### 3.2.1 応答時間

- **Webhook応答**: 3秒以内にLINEサーバーへ応答
- **メッセージ送信**: 5秒以内にユーザーへメッセージ配信
- **API呼び出し**: Google Calendar APIの効率的な利用

#### 3.2.2 スケーラビリティ

- **同時接続**: 複数ユーザーの同時利用に対応
- **負荷分散**: 必要に応じてスケールアウト可能な設計

### 3.3 可用性・信頼性

#### 3.3.1 稼働率

- **目標稼働率**: 99.5%以上
- **エラーハンドリング**: 適切なエラー処理とログ記録

#### 3.3.2 バックアップ

- **データバックアップ**: 定期的なデータベースバックアップ
- **災害復旧**: 障害発生時の復旧手順

### 3.4 保守性

#### 3.4.1 コード品質

- **コーディング規約**: 統一されたコーディングスタイル
- **テスト**: ユニットテスト、統合テストの実装
- **ドキュメント**: コードコメントおよび技術ドキュメントの整備

#### 3.4.2 ログ・モニタリング

- **ログ記録**: アプリケーションログ、エラーログの記録
- **モニタリング**: システム稼働状況の監視

---

## 4. システム構成

### 4.1 アーキテクチャ

#### 4.1.1 システム構成図

```
[LINE Platform] ←→ [Vercel (NestJS Webhook)] ←→ [Google Calendar API]
                              ↓
                    [Supabase (PostgreSQL)]
```

#### 4.1.2 採用技術スタック

- **言語**: TypeScript
- **フレームワーク**: NestJS (Node.js)
- **データベース**: Supabase (PostgreSQL)
- **ホスティング**: Vercel
- **LINE SDK**: @line/bot-sdk
- **Google SDK**: googleapis
- **ORM**: Prisma (Supabaseとの連携)
- **環境変数管理**: Vercel Environment Variables

#### 4.1.3 技術選定理由

**NestJS**:

- TypeScriptネイティブで型安全性が高い
- モジュール構造で保守性が高い
- Dependency Injectionによるテスタビリティ
- Webhookエンドポイントの実装が容易

**Vercel**:

- サーバーレスで自動スケーリング
- HTTPSが標準で提供される（LINE Webhook要件）
- デプロイが簡単（Git連携）
- 無料枠が充実

**Supabase**:

- PostgreSQLベースで信頼性が高い
- リアルタイム機能が標準搭載
- 認証機能が組み込み
- 無料枠が充実
- REST APIとPostgREST自動生成

### 4.2 データモデル

#### 4.2.1 主要エンティティ

- **Users**: ユーザー情報（LINE User ID、Google認証情報）
- **Messages**: LINE会話履歴
- **Events**: カレンダーイベント
- **Tasks**: 抽出されたタスク
- **Settings**: ユーザー設定

---

## 5. API仕様

### 5.1 LINE Messaging API

#### 5.1.1 使用エンドポイント

- **Webhook**: メッセージ受信
- **Reply API**: メッセージへの返信
- **Push API**: プッシュメッセージ送信
- **Profile API**: ユーザープロフィール取得

### 5.2 Google Calendar API

#### 5.2.1 使用エンドポイント

- **Events.list**: イベント一覧取得
- **Events.insert**: イベント作成
- **Events.update**: イベント更新
- **Events.delete**: イベント削除

---

## 6. データ処理ルール

### 6.1 LINEメッセージ処理

#### 6.1.1 処理優先度

1. **緊急キーワード**: 「緊急」「至急」などを含むメッセージは最優先
2. **日時情報**: 日時を含むメッセージはカレンダー登録候補
3. **タスクキーワード**: 「TODO」「やること」などを含むメッセージはタスク抽出
4. **通常メッセージ**: 履歴として保存

#### 6.1.2 プライバシー配慮

- **機密情報フィルタ**: パスワード、クレジットカード番号などの検出と除外
- **保存期間**: 会話履歴の保存期間を設定可能（デフォルト: 90日）
- **削除機能**: ユーザーが任意に履歴を削除可能

### 6.2 カレンダーイベント処理

#### 6.2.1 イベント同期

- **同期頻度**: 15分ごとに自動同期
- **競合解決**: Google Calendar側を正として処理
- **削除イベント**: 削除されたイベントは履歴として保持

---

## 7. ユーザーインターフェース

### 7.1 LINE Bot コマンド

#### 7.1.1 基本コマンド

- `/today`: 今日の予定を表示
- `/tomorrow`: 明日の予定を表示
- `/week`: 今週の予定を表示
- `/add [イベント内容]`: イベントを追加
- `/tasks`: タスク一覧を表示
- `/help`: ヘルプメッセージを表示

#### 7.1.2 設定コマンド

- `/settings`: 設定メニューを表示
- `/reminder [時間]`: リマインダー時間を設定
- `/timezone [タイムゾーン]`: タイムゾーンを設定

---

## 8. 開発フェーズ

### 8.1 フェーズ1: 基本機能（MVP）

- [ ] LINE Webhook受信機能
- [ ] 基本的なメッセージ応答
- [ ] Google Calendar認証
- [ ] イベント取得・表示機能

### 8.2 フェーズ2: 統合機能

- [ ] 会話履歴保存
- [ ] タスク抽出機能
- [ ] カレンダーイベント作成
- [ ] リマインダー機能

### 8.3 フェーズ3: 高度な機能

- [ ] 意思決定支援
- [ ] スケジュール最適化
- [ ] レポート機能
- [ ] 統計・分析機能

### 8.4 フェーズ4: 最適化・改善

- [ ] パフォーマンス最適化
- [ ] UI/UX改善
- [ ] セキュリティ強化
- [ ] ドキュメント整備

---

## 9. 制約事項・前提条件

### 9.1 制約事項

- LINE Messaging APIの無料プランの制限（月間メッセージ数など）
- Google Calendar APIのクォータ制限
- Webhookサーバーは公開URLが必要（HTTPSが必須）

### 9.2 前提条件

- LINE Developersアカウントの取得
- Google Cloud Platformアカウントの取得
- 適切なホスティング環境の準備

---

## 10. 今後の拡張可能性

### 10.1 追加機能候補

- **他のカレンダーサービス対応**: Outlook Calendar、Apple Calendarなど
- **AI機能**: 自然言語処理によるタスク抽出精度向上
- **他のメッセージングプラットフォーム**: Slack、Discord連携
- **音声対応**: LINE通話との連携
- **位置情報活用**: 移動時間を考慮したスケジュール提案

### 10.2 スケーラビリティ

- マルチテナント対応
- エンタープライズ向け機能
- API公開による外部サービス連携

---

## 11. 参考資料

### 11.1 公式ドキュメント

- [LINE Messaging API Documentation](https://developers.line.biz/ja/docs/messaging-api/)
- [Google Calendar API Documentation](https://developers.google.com/calendar/api/guides/overview)

### 11.2 関連技術

- OAuth 2.0
- Webhook
- RESTful API
- データベース設計

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2026-01-29 | 1.0 | 初版作成 | - |
