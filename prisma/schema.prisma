// Prismaスキーマファイル
// データベース: Supabase (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザー（個人のLINEユーザー）
model User {
  id                String    @id @default(uuid())
  lineUserId        String    @unique
  displayName       String?
  pictureUrl        String?
  timezone          String    @default("Asia/Tokyo")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  messages          Message[]
  tasks             Task[]
}

// ルーム（トークルーム、グループ、個人チャットの場）
model Room {
  id                String    @id @default(uuid())
  lineRoomId        String    @unique // userId, groupId, roomIdのいずれか
  type              String    // "user", "group", "room"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  messages          Message[]
}

// メッセージ（ルーム内でのユーザーの発言）
model Message {
  id            String   @id @default(uuid())
  lineMessageId String?  @unique
  roomId        String
  userId        String?  // システムからのメッセージの場合はnull
  messageType   String   // text, image, sticker, etc.
  textContent   String?  // テキストのみを抽出して保存 (例: "これか")
  rawContent    String?  // JSON全体の保存
  timestamp     DateTime @default(now())
  isFromUser    Boolean  @default(true)
  
  room          Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([roomId, userId, timestamp])
}

// タスク
model Task {
  id          String    @id @default(uuid())
  userId      String
  title       String
  description String?
  dueDate     DateTime?
  priority    Int       @default(0) // 0: low, 1: medium, 2: high
  status      String    @default("pending") // pending, in_progress, completed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, status])
  @@index([dueDate])
}
